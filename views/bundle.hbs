if (!window.pending_messages) {
    window.pending_messages = [];
}

window.onbeforeunload = confirmExit;

function confirmExit() {
    return confirm("You have attempted to leave this page. Are you sure?");
}



window.addEventListener('load', (event) => {
    const isReady = () => {
        console.log("ready")
        window.is_frame_ready = true;
        if (window.pending_messages && window.pending_messages.length) {
            window.pending_messages.forEach(msg =>
                window.sso_iframe.contentWindow.postMessage(msg)
            )
        }
    }
    const iframeURL = "{{{PROTOCOL}}}{{{BASE_URL}}}/sso/";
    window.sso_iframe = document.querySelector(`iframe[src='${iframeURL}']`);
    window.is_frame_ready = false;
    if (!window.sso_iframe) {
        window.sso_iframe = document.createElement("iframe");
        window.sso_iframe.setAttribute("src", iframeURL);
        window.sso_iframe.style.width = "1px";
        window.sso_iframe.style.height = "1px";
        window.sso_iframe.onload = isReady
        document.body.appendChild(window.sso_iframe);
    }

    window.APP.store.addEventListener("statechanged", ({
        target
    }) => {
        if (!target.state) {
            console.error("State invalid")
            return
        }
        const {
            credentials
        } = target.state;

        if (!credentials.email || !credentials.token) {
            console.error("No credentials found")
            return
        }

        try {
            const msg = {
                action: 'save',
                key: 'credentials',
                value: credentials
            }
            if (!window.is_frame_ready) {
                window.pending_messages.push(msg)
                console.log("added", msg)
                return
            }
            window.sso_iframe.contentWindow.postMessage(msg)
            debugger;
        } catch (e) {
            alert(e.message);
            console.error(e)
        }
    });
});